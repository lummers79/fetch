<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch - Your resource companion</title>
    <style>
      div {margin-bottom: 1em;}
            /* General layout */
    body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        background-color: #f9f9f9;
        color: #333;
    }

    /* Center-align title */
    h1 {
        color: #0066cc;
        text-align: center;
        margin-bottom: 20px;
    }

    /* Container for all content except the title */
    .content-container {
        width: 100%;
        max-width: 600px;
        text-align: left;
    }

    /* Form elements */
    label {
        font-weight: bold;
        margin-right: 10px;
    }

    select, button {
        padding: 10px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    button {
        background-color: #0066cc;
        color: #fff;
        border: none;
        cursor: pointer;
    }

    button:hover {
        background-color: #005bb5;
    }

    /* Resources display as larger tiles in a 3x3 grid */
    #assetsList {
        width: 100%;
        max-width: 700px;
        margin-top: 20px;
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* Fixed 3x3 grid */
        gap: 20px;
        justify-items: center;
    }

    .asset-tile {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background-color: #e0f7ff;
        color: #0066cc;
        text-align: center;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        font-size: 0.9em;
    }

    .asset-tile:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    .asset-tile a {
        color: #0066cc;
        text-decoration: none;
        font-weight: bold;
        text-align: center;
        padding: 10px;
        width: 100%;
    }
    
        /* Center-align button containers */
    .button-container {
        display: flex;
        justify-content: center;
        width: 100%;
        margin-top: 10px;
    }
    
        /* Instruction text above tiles */
    #downloadInstruction {
        font-size: 1.1em;
        color: #333;
        margin-bottom: 15px;
        text-align: center;
    }
      </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body>
    <h1>Choose Your Options</h1>
    
    <!-- Content container for left-aligned content -->
    <div class="content-container">
       
        <!-- Dropdown to select key stage -->
        <div>    
            <label for="keyStage">Which Key Stage?</label>
            <select id="keyStage">
                <option>Loading...</option>
            </select>
        </div>

        <!-- Dropdown to select subject -->
        <div>
            <label for="subject">Choose a Subject:</label>
            <select id="subject">
                <option>Loading...</option>
            </select>
        </div>

        <!-- Button to generate list of units based on selections -->
        
            <div class="button-container">
    <button onclick="fetchUnits()">Fetch Units</button>
</div>
        

        <!-- Dropdown to select unit -->
        <div>
            <label for="unit">Choose a Unit:</label>
            <select id="unit" onchange="fetchLessons()">
                <option>Select a unit...</option>
            </select>
        </div>

        <!-- Dropdown to select lesson -->
        <div>
            <label for="lesson">Choose a Lesson:</label>
            <select id="lesson">
                <option>Select a lesson...</option>
            </select>
        </div>

        <!-- Button to fetch resources based on the selected lesson -->
      <div class="button-container">
    <button onclick="fetchAssets()">Fetch Resources</button>
</div>

        <!-- Display area for the list of assets -->
        <div id="assetsList"></div>
    </div>


    <script>
        // Function to get key stages from the API
        async function fetchKeyStages() {
            const keyStageDropdown = document.getElementById('keyStage');
            keyStageDropdown.innerHTML = '<option>Loading...</option>';

            try {
                const response = await fetch('https://open-api.thenational.academy/api/v0/key-stages', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer 136a1135-7c62-43c9-9162-a124a1b2f81b`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }

                const data = await response.json();
                keyStageDropdown.innerHTML = '';

                data.forEach(option => {
                    const optElement = document.createElement('option');
                    optElement.value = option.slug;
                    optElement.textContent = option.slug;
                    keyStageDropdown.appendChild(optElement);
                });
            } catch (error) {
                console.error('Error fetching key stages:', error);
                keyStageDropdown.innerHTML = '<option>Error loading options</option>';
            }
        }

        // Function to get subjects from the API
        async function fetchSubjects() {
            const subjectDropdown = document.getElementById('subject');
            subjectDropdown.innerHTML = '<option>Loading...</option>';

            try {
                const response = await fetch('https://open-api.thenational.academy/api/v0/subjects', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer 136a1135-7c62-43c9-9162-a124a1b2f81b`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }

                const data = await response.json();
                subjectDropdown.innerHTML = '';

                data.forEach(option => {
                    const optElement = document.createElement('option');
                    optElement.value = option.subjectSlug;
                    optElement.textContent = option.subjectTitle;
                    subjectDropdown.appendChild(optElement);
                });
            } catch (error) {
                console.error('Error fetching subjects:', error);
                subjectDropdown.innerHTML = '<option>Error loading options</option>';
            }
        }

        // Function to fetch units based on selected key stage and subject
        async function fetchUnits() {
            const keyStage = document.getElementById('keyStage').value;
            const subject = document.getElementById('subject').value;
            const unitDropdown = document.getElementById('unit');
            unitDropdown.innerHTML = '<option>Loading units...</option>';

            try {
                const response = await fetch(`https://open-api.thenational.academy/api/v0/key-stages/${keyStage}/subject/${subject}/units`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer 136a1135-7c62-43c9-9162-a124a1b2f81b`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }

                const data = await response.json();
                unitDropdown.innerHTML = '<option>Select a unit...</option>';

                data.forEach(unit => {
                    const unitElement = document.createElement('option');
                    unitElement.value = unit.unitSlug;
                    unitElement.textContent = unit.unitTitle;
                    unitDropdown.appendChild(unitElement);
                });
            } catch (error) {
                console.error('Error fetching units:', error);
                unitDropdown.innerHTML = '<option>Error loading units</option>';
            }
        }

        // Function to fetch lessons based on selected unit and populate them as a dropdown
        async function fetchLessons() {
            const keyStage = document.getElementById('keyStage').value;
            const subject = document.getElementById('subject').value;
            const unit = document.getElementById('unit').value;
            const lessonDropdown = document.getElementById('lesson');
            lessonDropdown.innerHTML = '<option>Loading lessons...</option>';

            try {
                const response = await fetch(`https://open-api.thenational.academy/api/v0/key-stages/${keyStage}/subject/${subject}/lessons?unit=${unit}&offset=0&limit=10`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer 136a1135-7c62-43c9-9162-a124a1b2f81b`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }

                const data = await response.json();
                lessonDropdown.innerHTML = '<option>Select a lesson...</option>';

                if (data.length > 0 && data[0].lessons) {
                    data[0].lessons.forEach(lesson => {
                        const lessonOption = document.createElement('option');
                        lessonOption.value = lesson.lessonSlug;
                        lessonOption.textContent = lesson.lessonTitle;
                        lessonDropdown.appendChild(lessonOption);
                    });
                } else {
                    lessonDropdown.innerHTML = '<option>No lessons available for this unit.</option>';
                }
            } catch (error) {
                console.error('Error fetching lessons:', error);
                lessonDropdown.innerHTML = '<option>Error loading lessons</option>';
            }
        }

// Function to fetch assets, unzip ZIP files if necessary, and provide download links as tiles
async function fetchAssets() {
    const lesson = document.getElementById('lesson').value;
    const assetsList = document.getElementById('assetsList');
    assetsList.innerHTML = '<p>Loading resources...</p>';

    const assetLabels = {
        slidedeck: 'Slidedeck',
        exitQuiz: 'Exit Quiz',
        exitQuizAnswers: 'Exit Quiz Answers',
        starterQuiz: 'Starter Quiz',
        starterQuizAnswers: 'Starter Quiz Answers',
        supplementaryResource: 'Supplementary Resource',
        video: 'Video',
        worksheet: 'Worksheet',
        worksheetAnswers: 'Worksheet Answers'
    };

    try {
        console.log(`Fetching assets for Lesson: ${lesson}`);

        const response = await fetch(`https://open-api.thenational.academy/api/v0/lessons/${lesson}/assets`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer 136a1135-7c62-43c9-9162-a124a1b2f81b`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.statusText}`);
        }

        const data = await response.json();
        assetsList.innerHTML = '';  // Clear loading message

        if (data.assets && data.assets.length > 0) {
            for (const asset of data.assets) { 
                try {
                    const assetResponse = await fetch(asset.url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `136a1135-7c62-43c9-9162-a124a1b2f81b 136a1135-7c62-43c9-9162-a124a1b2f81b`
                        }
                    });

                    if (!assetResponse.ok) {
                        throw new Error(`Failed to get signed URL for asset: ${assetResponse.statusText}`);
                    }

                    const assetData = await assetResponse.json();
                    const signedUrl = assetData[0].url;

                    // Create a tile for each asset
                    const tile = document.createElement('div');
                    tile.classList.add('asset-tile');

                    // Set the tile label and download link
                    const label = assetLabels[asset.type] || asset.type;
                    const link = document.createElement('a');
                    link.href = signedUrl;
                    link.target = "_blank";
                    link.download = `${label}.zip`; // Set filename for download
                    link.textContent = label;

                    // Append link to tile
                    tile.appendChild(link);
                    assetsList.appendChild(tile);
                } catch (assetError) {
                    console.error(`Error processing asset ${asset.type}:`, assetError);
                    const errorItem = document.createElement('p');
                    errorItem.textContent = `Error loading ${asset.type}: ${assetError.message}`;
                    errorItem.style.color = 'red';
                    assetsList.appendChild(errorItem);
                }
            }
        } else {
            assetsList.innerHTML = '<p>No resources available for this lesson.</p>';
        }
    } catch (error) {
        console.error('Error fetching assets:', error);
        assetsList.innerHTML = '<p>Error loading resources</p>';
    }
}

        // Call fetch functions when the page loads
        window.onload = function() {
            fetchKeyStages();
            fetchSubjects();
        };
    </script>
</body>
</html>
